generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Bruker som logger inn via regnskapssystem
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Stripe
  stripeCustomerId String? @unique

  // Subscription
  subscriptionStatus  String    @default("none") // "none" | "active" | "cancelled" | "expired"
  subscriptionStarted DateTime?
  subscriptionEnds    DateTime?
  hasUsedTrial        Boolean   @default(false) // Sporer om bruker har brukt prøveperiode

  // Aktivt regnskapssystem
  activeProvider String? // "fiken" | "tripletex"

  // Vilkår og personvern
  acceptedTermsAt DateTime? // Når brukeren godtok vilkårene

  // Relasjoner
  accountingConnections AccountingConnection[]
  chats                 Chat[]

  @@index([email])
}

// Tilkobling til regnskapssystem (Fiken eller Tripletex)
model AccountingConnection {
  id       String @id @default(uuid())
  userId   String
  provider String // "fiken" | "tripletex"

  // Tokens
  accessToken   String // Fiken: access_token, Tripletex: session_token
  refreshToken  String? // Kun Fiken
  employeeToken String? // Kun Tripletex (for å opprette ny session)
  expiresAt     DateTime

  // Valgt selskap
  companyId          String? // Fiken: slug, Tripletex: numeric ID
  companyName        String?
  organizationNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
}

model Chat {
  id        String    @id @default(uuid())
  title     String
  userId    String?
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  messages  Message[]

  @@index([userId])
  @@index([createdAt])
}

model Message {
  id        String   @id @default(uuid())
  role      String   // "user" | "assistant"
  content   String
  createdAt DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId    String

  @@index([chatId])
  @@index([createdAt])
}

// E-post subscription for varsler om nye regnskapssystem-integrasjoner
model EmailSubscription {
  id               String    @id @default(uuid())
  email            String
  accountingSystem String    // "tripletex", "visma", "poweroffice", etc.
  otherSystem      String?   // Fritekst hvis "other" er valgt
  createdAt        DateTime  @default(now())
  unsubscribedAt   DateTime?

  @@unique([email, accountingSystem])
  @@index([accountingSystem])
  @@index([email])
}
